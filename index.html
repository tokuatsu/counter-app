<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
      content="width=device-width, initial-scale=1,
               maximum-scale=1, user-scalable=no">
  <title>カウンター</title>

  <style>
    :root{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
    }
    body{margin:0;padding:16px;background:#f4f6f9;}
    h1{font-size:18px;margin:0 0 12px;}

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 0 0 14px;
    }
    .toolbtn{
      height:42px;
      padding:0 14px;
      border:0;
      border-radius:10px;
      background:#1f6feb;
      color:#fff;
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .toolbtn.secondary{ background:#6e7781; }
    .toolbtn:active{ transform:scale(0.98); }

    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media (min-width:520px){ .grid{grid-template-columns:1fr 1fr;} }

    .card{
      background:#fff;
      padding:14px;
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
    }

    .toprow{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }

    .name-input{
      flex:1;
      font-size:16px;
      font-weight:800;
      border:1px solid #e1e6ef;
      border-radius:10px;
      padding:8px 10px;
      box-sizing:border-box;
      background:#fff;
    }

    .delbtn{
      width:44px;height:40px;
      border:0;border-radius:10px;
      background:#f2f2f2;
      cursor:pointer;
      font-weight:900;
      -webkit-tap-highlight-color:transparent;
    }
    .delbtn:active{ transform:scale(0.97); }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }

    .btns{display:flex;gap:10px;}

    .btn{
      width:52px;height:44px;
      border:0;border-radius:10px;
      background:#e5eaf2;
      font-size:22px;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:active{ transform:scale(0.97); }

    .value{
      font-size:28px;
      font-weight:900;
      min-width:70px;
      text-align:center;
    }

    .hint{font-size:12px;color:#666;margin-top:8px;}
  </style>
</head>

<body>
  <h1>カウンター</h1>

  <!-- 操作ボタン -->
  <div class="toolbar">
    <button class="toolbtn" type="button" id="addGroupBtn">＋ グループ追加</button>
    <button class="toolbtn secondary" type="button" id="resetBtn">初期化</button>
  </div>

  <!-- グループ表示 -->
  <div class="grid" id="grid"></div>

  <script>
    /*
      要件：
      - グループ数は自由に増やせる（追加ボタン）
      - マイナスは0未満禁止
      - 初期化ボタン（確認あり）
      - 名前も変更可能
      - 変更は自動保存（localStorage）
      - ついでに：グループ削除（確認あり）
    */

    const STORAGE_KEY = "counter_app_dynamic_v1";

    // 初期グループ（初期化時にここへ戻す）
    function defaultGroups() {
      return [
        { id: makeId(), name: "グループ1", value: 0 },
        { id: makeId(), name: "グループ2", value: 0 },
        { id: makeId(), name: "グループ3", value: 0 },
        { id: makeId(), name: "グループ4", value: 0 },
      ];
    }

    // グループ配列（状態）
    let groups = [];

    // できるだけ被らないID
    function makeId() {
      return "g_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 8);
    }

    function save() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(groups));
    }

    function load() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        groups = defaultGroups();
        save();
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        // 形式チェック（壊れてたら初期化）
        if (!Array.isArray(parsed)) throw new Error("not array");
        groups = parsed.map(g => ({
          id: String(g.id ?? makeId()),
          name: String(g.name ?? "グループ"),
          value: Number.isFinite(g.value) ? g.value : 0
        }));
      } catch (e) {
        groups = defaultGroups();
        save();
      }
    }

    // 次の「グループN」番号を作る（既存の最大+1）
    function nextGroupNumber() {
      let max = 0;
      for (const g of groups) {
        const m = String(g.name).match(/^グループ(\d+)$/);
        if (m) max = Math.max(max, Number(m[1]));
      }
      return max + 1;
    }

    const grid = document.getElementById("grid");

    function render() {
      // DOMを作り直す（シンプル＆確実）
      grid.innerHTML = "";

      groups.forEach(g => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.id = g.id;

        card.innerHTML = `
          <div class="toprow">
            <input class="name-input" data-name value="${escapeHtml(g.name)}" />
            <button class="delbtn" type="button" data-action="delete" title="このグループを削除">✕</button>
          </div>

          <div class="row">
            <div class="btns">
              <button class="btn" type="button" data-action="dec">−</button>
              <button class="btn" type="button" data-action="inc">＋</button>
            </div>
            <div class="value" data-value>${g.value}</div>
          </div>

        `;

        grid.appendChild(card);
      });
    }

    // HTMLのvalueに入れる用（最低限）
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#39;");
    }

    // 初期ロード
    load();
    render();

    // 追加ボタン
    document.getElementById("addGroupBtn").addEventListener("click", () => {
      const n = nextGroupNumber();
      groups.push({ id: makeId(), name: `グループ${n}`, value: 0 });
      save();
      render();
    });

    // 初期化ボタン（確認あり）
    document.getElementById("resetBtn").addEventListener("click", () => {
      const ok = confirm("初期化します。\n（グループ数・名前・数値が初期状態に戻ります）\nよろしいですか？");
      if (!ok) return;

      groups = defaultGroups();
      save();
      render();
    });

    // ＋／−／削除（イベント委任）
    document.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-action]");
      if (!btn) return;

      const card = btn.closest(".card");
      const id = card?.dataset.id;
      if (!id) return;

      const g = groups.find(x => x.id === id);
      if (!g) return;

      const action = btn.dataset.action;

      if (action === "inc") {
        g.value += 1;
      }

      if (action === "dec") {
        // 0未満禁止
        g.value = Math.max(0, g.value - 1);
      }

      if (action === "delete") {
        const ok = confirm(`「${g.name}」を削除します。よろしいですか？`);
        if (!ok) return;
        groups = groups.filter(x => x.id !== id);
      }

      save();
      render();
    });

    // グループ名変更（入力中に保存）
    document.addEventListener("input", (e) => {
      const inp = e.target.closest("input[data-name]");
      if (!inp) return;

      const card = inp.closest(".card");
      const id = card?.dataset.id;
      if (!id) return;

      const g = groups.find(x => x.id === id);
      if (!g) return;

      g.name = inp.value;
      save();
      // renderはしない（入力中にカーソルが飛ぶのを防ぐ）
    });
  </script>
</body>
</html>

